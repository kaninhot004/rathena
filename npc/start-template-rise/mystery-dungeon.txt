// Server start -> Setup monster id each room
// Everytime player login -> Check not allow map -> Move to prontera
// Spawn monster when player enter + Request map
// Spawn +1 more on monster dead
// Every 10 minutes -> Check not allow map -> Move to prontera -> Setup monster id each room
-	script	MysteryDungeon	-1,{
	end;
	
OnMinute00:
OnMinute10:
OnMinute20:
OnMinute30:
OnMinute40:
OnMinute50:
	// Every 10 minutes -> Re-initialize
	$isMysteryDungeonInit = 0;
	
OnSetupMonsterId:
	// Check if already initialize
	if ($isMysteryDungeonInit)
	return;

	// Loop 100 rooms
	for(.@i = 0; .@i < 100; .@i++){
		// Clear monster on map
		killmonsterall $mysteryDungeonMapName$[.@i];
		// Clear monster set list
		deletearray getd("$mysteryDungeonMID" + .@i + "[0]"),getarraysize(getd("$mysteryDungeonMID" + .@i));
		// Setup monster set list
		setarray getd("$mysteryDungeonMID" + .@i + "[0]"),$attackableMonsterIds[rand(getarraysize($attackableMonsterIds))],$attackableMonsterIds[rand(getarraysize($attackableMonsterIds))],$attackableMonsterIds[rand(getarraysize($attackableMonsterIds))],$attackableMonsterIds[rand(getarraysize($attackableMonsterIds))];
		// Setup boss
		set getd("$mysteryDungeonMVP" + .@i),$mvpIds[rand(getarraysize($mvpIds))];
	}
	
	// Mark as initialized
	$isMysteryDungeonInit = 1;
	
	end;

OnSpawnMore:
	.@index = getarg(0,0);
	.@amount = getarg(1,0);
	.@isNonBoss = getarg(2,1);
	.@isBoss = getarg(3,1);
	if(.@isNonBoss){
		freeloop(1);
		for(.@i = 0; .@i < .@amount; .@i++)
		monster $mysteryDungeonMapName$[.@index],0,0,"--ja--",getd("$mysteryDungeonMID" + .@index + "[" + rand(0,3) + "]"),1,strnpcinfo(0) + "::OnMonsterDead" + .@index;
		freeloop(0);
	}
	if(.@isBoss && !getd("$isMysteryDungeonBossDead" + .@index))
	monster $mysteryDungeonMapName$[.@index],0,0,"--ja--",getd("$mysteryDungeonMVP" + .@index),1,strnpcinfo(0) + "::OnBossDead" + .@index;
	return;

OnMonsterDead0: callsub OnGetReward,0; callsub OnSpawnMore,0,1,1,0; end;
OnBossDead0: callsub OnGetReward,1; $isMysteryDungeonBossDead0 = 1; end;

OnGetReward:
	.@isBoss = getarg(0,0);
	// Reward EXP
	return;

OnInit:
	// Spawn amount per map
	$mysteryDungeonSpawnAmount = 150;
	
	// First time initialize
	if(!$isMysteryDungeonInit)
	callsub OnSetupMonsterId;

	end;
}
